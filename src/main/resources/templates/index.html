<!DOCTYPE html>
<html ng-app="app" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link th:href="@{/webjars/bootstrap/3.3.5/css/bootstrap.min.css}" rel="stylesheet" media="screen"/>

    <link th:href="@{/css/ind.css}" rel="stylesheet"/>
    <link th:href="@{/css/common.css}" rel="stylesheet"/>

    <link th:href="@{/css/navbar.css}" rel="stylesheet"/>
    <link rel="stylesheet" media="screen" th:href="@{/fonts/font-awesome/font-awesome.min.css}"/>
    <link rel="stylesheet" media="screen" th:href="@{/css/bootstrap-dialog.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/semantic/dist/semantic.min.css}"/>


    <title>Online shop</title>
</head>
<body>
<div id="nav"></div>

<header id="about">
    <div class="container">
        <div class="intro-text">
            <div class="intro-lead-in">Test application</div>
            <div class="intro-heading">Developed by Tomasz Zielichowski</div>
        </div>
    </div>
</header>

<div class="container">

    <div class="row">
        <section class="content" id="shop">

            <div ng-controller="Products" id="productsTableBody">
                <div class="col-md-9 col-lg-9 ">
                    <div ng-repeat="product in products" update-checkbox-directive>
                        <div class="clearfix" ng-show="$index % 3 == 0"></div>

                        <div class="col-sm-4 col-lg-4 col-md-4">
                            <div class="thumbnail simpleCart_shelfItem">
                                <img class="img-responsive item_image"
                                     ng-src="data:image/JPEG;base64,{{product.image}}">
                                <div class="caption">
                                    <h4 class="item_name">{{product.description}}</h4>
                                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor
                                        incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis
                                        nostrud
                                        exercitation ullamco laboris nisi ut aliquip </p>
                                    <h4 class="pull-right item_price"><strong>{{product.price.denomination}}
                                        {{product.price.currencyCode}}</strong></h4>
                                </div>

                                <div class="item_id hidden" >{{product.id}}</div>

                                <a class="item_add" href="javascript:;"> Add to Cart </a>

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="basket" class="col-xs-12 col-sm-12 col-md-3 col-lg-3">
                <div class="simpleCart_items"></div>

                <div class="panel panel-green">
                    <div class="panel-heading">
                        <div class="row">
                            <div class="col-xs-3">
                                <i class="fa fa-shopping-cart fa-4x"></i>
                            </div>
                            <div class="col-xs-9 text-right">
                                <div class="simpleCart_total">Current total price !</div>
                            </div>
                        </div>

                    </div>
                        <div class="panel-footer">
                            <button type="submit" class="simpleCart_checkout btn btn-info pull-rightâ™ ">Place order ! <i
                                    class="fa fa-arrow-circle-right"></i></button>
                            <div class="clearfix"></div>
                            <a href="javascript:;" class=" btn btn-info simpleCart_empty">Clear shopping cart </a>

                        </div>
                </div>
            </div>
        </section>
    </div>

</div>
<!-- start contact -->
<section id="contact">

</section>
<!-- end contact -->

<script th:src="@{/webjars/angularjs/1.0.8/angular.min.js}"></script>
<script th:src="@{/webjars/jquery/2.1.4/jquery.min.js}" type="text/javascript"></script>
<script th:src="@{/webjars/bootstrap/3.3.5/js/bootstrap.min.js}" type="text/javascript"></script>
<script th:src="@{/js/nav.js}" type="text/javascript"></script>
<script th:src="@{/js/contact.js}" type="text/javascript"></script>
<script th:src="@{/semantic/dist/semantic.min.js}"></script>

<script th:src="@{/js/products.js}"></script>
<script th:src="@{/js/bootstrap-dialog.js}"></script>
<script th:src="@{/js/shoppingCart.js}"></script>

<script th:src="@{/js/simpleCart.js}"></script>
<script>

    simpleCart.bind("afterCreate", function () {
        $cart_table = $(".simpleCart_items table")
        $cart_table.addClass("table").addClass("table-hover")
    });



    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");


    simpleCart({
        checkout: {
            type: "SendForm",
            url: "/order",
            extra_data: {
                _csrf: token,
                _csrf_header: header
            }
        },
        currency: "EUR",


        cartColumns: [
            {
                view: function (item, column) {
                    return "<img src='" + item.get('image') + "' height=\"60\" width=\"60\">";
                },
                attr: 'image'
            },
            {attr: "price", label: "Price", view: 'currency'},

            {attr: "quantity", label: "Qty"},

            {attr: "total", label: "SubTotal", view: 'currency'},
            {view: "remove", text: "Remove", label: false}

        ],
        cartStyle: "table"
    });

</script>

<script type="text/javascript">
    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");
    $(document).ajaxSend(function (e, xhr, options) {
        xhr.setRequestHeader(header, token);
    });
</script>

<script type="text/javascript">

    var money = null;
    function assignToGlobalVariableUserMoney(userMoney) {
        money = userMoney;
    }

    simpleCart.bind( 'beforeAdd' , function( item ){
        var price =  item.get('price');
        if(money.denomination >= price){
            money.denomination = money.denomination - price;
            updateNavbarUserMoney(money);
        }else{
            alert('Sorry, you do not have enough money for this product');
            return false;
        }
        console.log(money);
        return true;
    });


    simpleCart.bind( 'beforeRemove' , function( item ){
         var totalCost = item.get('total');
         money.denomination = money.denomination + totalCost;
         updateNavbarUserMoney(money);

    });

    $(document).ready(function () {
        // clear shopping cart after page refresh
        sessionStorage.clear();

        userMoney(assignToGlobalVariableUserMoney);
        userMoney(updateNavbarUserMoney);


        $('body').scrollspy({
            target: '.navbar-fixed-top',
            offset: 50
        });
    })


</script>

</body>
</html>